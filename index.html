<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Matematica VeselÄƒ - Joc pentru Copii</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --pink: #FFB6C1;
  --lavender: #C3B1E1;
  --mint: #B2F2BB;
  --sky: #A0D2DB;
  --peach: #FFDAB9;
  --yellow: #FFF3B0;
  --coral: #FF8A80;
  --bg: #FFF8F0;
  --text: #4A3728;
  --text-light: #7A6558;
  --card: #FFFFFF;
  --shadow: 0 4px 20px rgba(0,0,0,0.08);
  --radius: 20px;
  --btn-size: 72px;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  min-height: 100dvh;
  min-height: -webkit-fill-available;
  height: var(--app-height, 100vh);
  padding: 12px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
  overscroll-behavior: none;
}

/* â”€â”€â”€ Zoo Bar â”€â”€â”€ */
#zoo-bar {
  width: 100%;
  max-width: 700px;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 12px 16px;
  margin-bottom: 10px;
  position: relative;
}

#zoo-bar .zoo-title {
  font-size: 15px;
  font-weight: 800;
  color: var(--text-light);
  text-align: center;
  margin-bottom: 6px;
  letter-spacing: 0.5px;
}

#zoo-animals {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  justify-content: center;
  font-size: 26px;
  line-height: 1;
}

#zoo-animals .animal-slot {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  transition: transform 0.3s, background 0.3s;
  position: relative;
  cursor: default;
}

#zoo-animals .animal-slot.collected {
  background: var(--yellow);
  animation: popIn 0.4s ease;
}

#zoo-animals .animal-slot.locked {
  filter: grayscale(1);
  opacity: 0.35;
  font-size: 20px;
}

#zoo-animals .animal-slot .animal-name-tip {
  display: none;
  position: absolute;
  bottom: 110%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: #fff;
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 8px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 10;
}

@media (hover: hover) {
  #zoo-animals .animal-slot.collected:hover .animal-name-tip {
    display: block;
  }
}

#zoo-animals .animal-slot.collected:active .animal-name-tip {
  display: block;
}

/* Progress bar to next animal */
#progress-wrap {
  margin-top: 8px;
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
}

#progress-wrap .progress-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-light);
  white-space: nowrap;
}

#progress-track {
  flex: 1;
  height: 14px;
  background: #EDE7E0;
  border-radius: 7px;
  overflow: hidden;
  position: relative;
}

#progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--peach), var(--pink));
  border-radius: 7px;
  transition: width 0.5s ease;
  width: 0%;
}

#star-count {
  font-size: 14px;
  font-weight: 800;
  color: var(--text);
  min-width: 40px;
  text-align: right;
}

/* â”€â”€â”€ Main Card â”€â”€â”€ */
#game-card {
  width: 100%;
  max-width: 700px;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px 20px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  min-height: 0;
  position: relative;
  overflow-x: hidden;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* Problem display */
#problem-area {
  width: 100%;
  text-align: center;
  margin-bottom: 8px;
  min-height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#problem-text {
  font-size: 52px;
  font-weight: 900;
  color: var(--text);
  letter-spacing: 2px;
  transition: opacity 0.3s, transform 0.3s;
}

#problem-text.fade-out {
  opacity: 0;
  transform: scale(0.9);
}

/* Answer display */
#answer-display {
  font-size: 48px;
  font-weight: 900;
  color: var(--lavender);
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 6px;
  letter-spacing: 3px;
}

#answer-display .cursor {
  display: inline-block;
  width: 3px;
  height: 44px;
  background: var(--lavender);
  margin-left: 2px;
  animation: blink 0.8s step-end infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}

/* Feedback area */
#feedback-area {
  min-height: 52px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin-bottom: 6px;
  text-align: center;
  transition: opacity 0.3s;
}

#feedback-text {
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
}

/* Visual explanation (dots) */
#visual-explanation {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  animation: fadeIn 0.5s ease;
}

#visual-explanation .dot-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

#visual-explanation .dot {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: inline-block;
}

#visual-explanation .dot-label {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-light);
}

#visual-explanation .explanation-text {
  font-size: 18px;
  font-weight: 800;
  color: var(--text);
}

/* Number pad */
#numpad {
  display: grid;
  grid-template-columns: repeat(3, var(--btn-size));
  gap: 10px;
  margin-top: auto;
  padding-bottom: 8px;
}

.num-btn {
  width: var(--btn-size);
  height: var(--btn-size);
  border: none;
  border-radius: 18px;
  font-family: 'Nunito', sans-serif;
  font-size: 30px;
  font-weight: 800;
  cursor: pointer;
  transition: transform 0.12s, box-shadow 0.12s, background 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  -webkit-appearance: none;
}

.num-btn:active {
  transform: scale(0.92);
}

.num-btn.digit {
  background: #F3EDE6;
  color: var(--text);
  box-shadow: 0 3px 0 #D9D0C7;
}

.num-btn.digit:active {
  box-shadow: 0 1px 0 #D9D0C7;
}

.num-btn.clear {
  background: var(--coral);
  color: #fff;
  box-shadow: 0 3px 0 #E06050;
  font-size: 18px;
}

.num-btn.submit {
  background: var(--mint);
  color: #2D6A2E;
  box-shadow: 0 3px 0 #7BC47E;
  font-size: 18px;
}

.num-btn.next {
  background: var(--sky);
  color: #2A5F6A;
  box-shadow: 0 3px 0 #6AABB8;
  font-size: 16px;
  grid-column: 1 / -1;
}

/* â”€â”€â”€ Stats overlay â”€â”€â”€ */
#stats-btn {
  position: fixed;
  top: 14px;
  right: 14px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--card);
  box-shadow: var(--shadow);
  border: none;
  font-size: 22px;
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  -webkit-appearance: none;
}

#stats-overlay {
  display: none;
  position: fixed;
  top: 0; right: 0; bottom: 0; left: 0;
  background: rgba(0,0,0,0.35);
  z-index: 200;
  align-items: center;
  justify-content: center;
}

#stats-overlay.open {
  display: flex;
}

#stats-panel {
  background: var(--card);
  border-radius: var(--radius);
  padding: 32px 28px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.15);
  text-align: center;
  animation: popIn 0.35s ease;
}

#stats-panel h2 {
  font-size: 26px;
  font-weight: 900;
  margin-bottom: 20px;
  color: var(--text);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 2px solid #F0EAE3;
  font-size: 18px;
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-label {
  font-weight: 700;
  color: var(--text-light);
}

.stat-value {
  font-weight: 900;
  color: var(--text);
  font-size: 22px;
}

#stats-close {
  margin-top: 20px;
  padding: 12px 36px;
  border: none;
  border-radius: 14px;
  background: var(--lavender);
  color: #fff;
  font-family: 'Nunito', sans-serif;
  font-size: 18px;
  font-weight: 800;
  cursor: pointer;
  touch-action: manipulation;
  -webkit-appearance: none;
}

#reset-btn {
  margin-top: 12px;
  padding: 8px 20px;
  border: none;
  border-radius: 10px;
  background: var(--coral);
  color: #fff;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  touch-action: manipulation;
  -webkit-appearance: none;
}

/* â”€â”€â”€ Streak badge â”€â”€â”€ */
#streak-badge {
  position: fixed;
  top: 14px;
  left: 14px;
  background: var(--card);
  box-shadow: var(--shadow);
  border-radius: 30px;
  padding: 6px 14px;
  font-size: 15px;
  font-weight: 800;
  color: var(--text);
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.3s;
}

#streak-badge.visible {
  opacity: 1;
}

/* â”€â”€â”€ Confetti & celebration â”€â”€â”€ */
#celebration-overlay {
  display: none;
  position: fixed;
  top: 0; right: 0; bottom: 0; left: 0;
  z-index: 300;
  pointer-events: none;
  align-items: center;
  justify-content: center;
}

#celebration-overlay.active {
  display: flex;
}

#celebration-text {
  font-size: 28px;
  font-weight: 900;
  color: var(--text);
  text-align: center;
  background: rgba(255,255,255,0.92);
  border-radius: var(--radius);
  padding: 28px 32px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.12);
  animation: popIn 0.5s ease;
  max-width: 85%;
  pointer-events: auto;
}

canvas#confetti-canvas {
  position: fixed;
  top: 0; right: 0; bottom: 0; left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 250;
}

/* â”€â”€â”€ New animal popup â”€â”€â”€ */
#new-animal-popup {
  display: none;
  position: fixed;
  top: 0; right: 0; bottom: 0; left: 0;
  background: rgba(0,0,0,0.35);
  z-index: 400;
  align-items: center;
  justify-content: center;
}

#new-animal-popup.open {
  display: flex;
}

#new-animal-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 32px;
  text-align: center;
  box-shadow: 0 8px 40px rgba(0,0,0,0.18);
  animation: popIn 0.5s ease;
  max-width: 320px;
  width: 85%;
}

#new-animal-card .animal-big {
  font-size: 72px;
  margin-bottom: 8px;
}

#new-animal-card .animal-label {
  font-size: 24px;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 8px;
}

#new-animal-card .animal-msg {
  font-size: 17px;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 18px;
}

#new-animal-card button {
  padding: 12px 36px;
  border: none;
  border-radius: 14px;
  background: var(--mint);
  color: #2D6A2E;
  font-family: 'Nunito', sans-serif;
  font-size: 18px;
  font-weight: 800;
  cursor: pointer;
  touch-action: manipulation;
  -webkit-appearance: none;
}

/* â”€â”€â”€ Star burst animation â”€â”€â”€ */
.star-burst {
  position: fixed;
  font-size: 36px;
  pointer-events: none;
  z-index: 150;
  animation: starFloat 1s ease-out forwards;
}

@keyframes starFloat {
  0% { opacity: 1; transform: scale(0.5) translateY(0); }
  60% { opacity: 1; transform: scale(1.2) translateY(-60px); }
  100% { opacity: 0; transform: scale(1) translateY(-100px); }
}

@keyframes popIn {
  0% { transform: scale(0.6); opacity: 0; }
  70% { transform: scale(1.08); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-6px); }
  80% { transform: translateX(6px); }
}

.shake {
  animation: shake 0.4s ease;
}

@keyframes correctPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.correct-pulse {
  animation: correctPulse 0.4s ease;
}

/* Responsive tweaks */
@media (max-width: 400px) {
  :root { --btn-size: 62px; }
  #problem-text { font-size: 40px; }
  #answer-display { font-size: 38px; }
  #numpad { gap: 8px; }
  .num-btn { font-size: 26px; border-radius: 14px; }
  #zoo-animals { font-size: 22px; }
  #zoo-animals .animal-slot { width: 30px; height: 30px; }
}

@media (min-width: 700px) {
  :root { --btn-size: 80px; }
  #problem-text { font-size: 64px; }
  #answer-display { font-size: 54px; }
  .num-btn { font-size: 34px; }
}
</style>
</head>
<body>

<!-- Streak badge -->
<div id="streak-badge">ğŸ”¥ <span id="streak-num">0</span></div>

<!-- Stats button -->
<button id="stats-btn" aria-label="Statistici">ğŸ“Š</button>

<!-- Zoo bar -->
<div id="zoo-bar">
  <div class="zoo-title">ğŸ¦ GrÄƒdina Zoo ğŸ¦</div>
  <div id="zoo-animals"></div>
  <div id="progress-wrap">
    <span class="progress-label">UrmÄƒtorul animal:</span>
    <div id="progress-track"><div id="progress-fill"></div></div>
    <span id="star-count">â­ 0/5</span>
  </div>
</div>

<!-- Main game card -->
<div id="game-card">
  <div id="problem-area">
    <div id="problem-text"></div>
  </div>
  <div id="answer-display"><span id="answer-digits"></span><span class="cursor"></span></div>
  <div id="feedback-area">
    <div id="feedback-text"></div>
  </div>
  <div id="visual-explanation"></div>
  <div id="numpad"></div>
</div>

<!-- Stats overlay -->
<div id="stats-overlay">
  <div id="stats-panel">
    <h2>ğŸ“Š Statistici</h2>
    <div class="stat-row"><span class="stat-label">Rezolvate</span><span class="stat-value" id="stat-solved">0</span></div>
    <div class="stat-row"><span class="stat-label">Precizie</span><span class="stat-value" id="stat-accuracy">0%</span></div>
    <div class="stat-row"><span class="stat-label">Animale colecÈ›ionate</span><span class="stat-value" id="stat-animals">0 / 20</span></div>
    <div class="stat-row"><span class="stat-label">Cel mai mare streak</span><span class="stat-value" id="stat-best-streak">0</span></div>
    <button id="stats-close">Ãnchide</button>
    <br>
    <button id="reset-btn">ReseteazÄƒ progresul</button>
  </div>
</div>

<!-- New animal popup -->
<div id="new-animal-popup">
  <div id="new-animal-card">
    <div class="animal-big" id="popup-animal-emoji"></div>
    <div class="animal-label" id="popup-animal-name"></div>
    <div class="animal-msg">FelicitÄƒri! Ai primit un animal nou Ã®n grÄƒdina ta zoo! ğŸ‰</div>
    <button id="popup-close">Super! ğŸŒŸ</button>
  </div>
</div>

<!-- Celebration overlay -->
<div id="celebration-overlay">
  <div id="celebration-text"></div>
</div>

<!-- Confetti canvas -->
<canvas id="confetti-canvas"></canvas>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ANIMALS = [
  { emoji: 'ğŸ¶', name: 'CÄƒÈ›eluÈ™ul' },
  { emoji: 'ğŸ±', name: 'PisicuÈ›a' },
  { emoji: 'ğŸ¦Š', name: 'VulpiÈ›a' },
  { emoji: 'ğŸ¼', name: 'UrsuleÈ›ul Panda' },
  { emoji: 'ğŸ¦', name: 'LeuÈ›ul' },
  { emoji: 'ğŸ¸', name: 'BroscuÈ›a' },
  { emoji: 'ğŸ¦‹', name: 'FluturaÈ™ul' },
  { emoji: 'ğŸ¢', name: 'Broasca ÈšestoasÄƒ' },
  { emoji: 'ğŸ¬', name: 'Delfinul' },
  { emoji: 'ğŸ¦„', name: 'Unicornul' },
  { emoji: 'ğŸ§', name: 'Pinguinul' },
  { emoji: 'ğŸ', name: 'AlbinuÈ›a' },
  { emoji: 'ğŸ¦‰', name: 'BufniÈ›a' },
  { emoji: 'ğŸ™', name: 'CaracatiÈ›a' },
  { emoji: 'ğŸ¦©', name: 'Flamingo' },
  { emoji: 'ğŸ¨', name: 'Koala' },
  { emoji: 'ğŸ¦’', name: 'Girafa' },
  { emoji: 'ğŸ³', name: 'Balena' },
  { emoji: 'ğŸ¦', name: 'È˜opÃ¢rla' },
  { emoji: 'ğŸ', name: 'Buburuza' },
];

const CORRECT_MSGS = [
  'Bravo! ğŸŒŸ',
  'Excelent! âœ¨',
  'EÈ™ti un campion! ğŸ†',
  'Super tare! ğŸ’ª',
  'Foarte bine! ğŸ‘',
  'Wow, ce deÈ™teaptÄƒ eÈ™ti! ğŸ¤©',
  'Minunat! ğŸ‰',
  'Perfect! ğŸ’¯',
  'Genial! ğŸš€',
  'Fantasticcc! ğŸŒˆ',
];

const RETRY_MSGS = [
  'Hmm, mai gÃ¢ndeÈ™te-te puÈ›in!',
  'Aproape! Mai Ã®ncearcÄƒ!',
  'Hai, tu poÈ›i! ğŸ’ª',
  'Nu-i nimic, hai din nou!',
  'Mai Ã®ncearcÄƒ o datÄƒ! ğŸ˜Š',
];

const COLORS = ['#FFB6C1','#C3B1E1','#B2F2BB','#A0D2DB','#FFDAB9','#FFF3B0','#FF8A80','#90CAF9','#F48FB1','#CE93D8'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let state = loadState();

function defaultState() {
  return {
    difficulty: 1,       // 1-5
    stars: 0,
    animalsCollected: 0,
    totalSolved: 0,
    totalAttempts: 0,
    correctCount: 0,
    streak: 0,
    bestStreak: 0,
    consecCorrect: 0,   // for difficulty scaling
  };
}

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem('mathzoo_state'));
    if (s && typeof s.difficulty === 'number') return s;
  } catch(e) {}
  return defaultState();
}

function saveState() {
  localStorage.setItem('mathzoo_state', JSON.stringify(state));
}

// Current problem
let currentProblem = null;
let currentRetries = 0;
let answerStr = '';
let waitingForNext = false;
let showingExplanation = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROBLEM GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateProblem() {
  const d = state.difficulty;
  let a, b, op, answer;

  // Pick operation based on difficulty
  const ops = ['+'];
  if (d >= 2) ops.push('-');
  if (d >= 3) ops.push('Ã—');

  op = ops[Math.floor(Math.random() * ops.length)];

  switch (op) {
    case '+':
      if (d <= 1) {
        a = rand(1, 5);  b = rand(1, 5);
      } else if (d === 2) {
        a = rand(2, 10); b = rand(1, 9);
      } else if (d === 3) {
        a = rand(5, 15); b = rand(2, 10);
      } else if (d === 4) {
        a = rand(10, 30); b = rand(5, 20);
      } else {
        a = rand(10, 50); b = rand(10, 50);
      }
      answer = a + b;
      break;
    case '-':
      if (d <= 2) {
        a = rand(3, 10); b = rand(1, a - 1);
      } else if (d === 3) {
        a = rand(5, 15); b = rand(1, a - 1);
      } else if (d === 4) {
        a = rand(10, 30); b = rand(2, a - 1);
      } else {
        a = rand(15, 50); b = rand(5, a - 1);
      }
      answer = a - b;
      break;
    case 'Ã—':
      if (d <= 3) {
        a = rand(1, 3); b = rand(1, 5);
      } else if (d === 4) {
        a = rand(2, 5); b = rand(2, 5);
      } else {
        a = rand(2, 5); b = rand(2, 9);
      }
      answer = a * b;
      break;
  }

  return { a, b, op, answer };
}

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $problem = document.getElementById('problem-text');
const $answerDigits = document.getElementById('answer-digits');
const $feedback = document.getElementById('feedback-text');
const $feedbackArea = document.getElementById('feedback-area');
const $numpad = document.getElementById('numpad');
const $zooAnimals = document.getElementById('zoo-animals');
const $progressFill = document.getElementById('progress-fill');
const $starCount = document.getElementById('star-count');
const $streakBadge = document.getElementById('streak-badge');
const $streakNum = document.getElementById('streak-num');
const $visualExplanation = document.getElementById('visual-explanation');

function renderZoo() {
  $zooAnimals.innerHTML = '';
  ANIMALS.forEach((animal, i) => {
    const slot = document.createElement('div');
    slot.className = 'animal-slot ' + (i < state.animalsCollected ? 'collected' : 'locked');
    slot.textContent = i < state.animalsCollected ? animal.emoji : 'â“';
    if (i < state.animalsCollected) {
      const tip = document.createElement('span');
      tip.className = 'animal-name-tip';
      tip.textContent = animal.name;
      slot.appendChild(tip);
    }
    $zooAnimals.appendChild(slot);
  });
}

function renderProgress() {
  const starsToNext = state.stars % 5;
  const pct = (starsToNext / 5) * 100;
  $progressFill.style.width = pct + '%';
  $starCount.textContent = 'â­ ' + starsToNext + '/5';
}

function renderStreak() {
  $streakNum.textContent = state.streak;
  $streakBadge.classList.toggle('visible', state.streak >= 2);
}

function showProblem() {
  waitingForNext = false;
  showingExplanation = false;
  currentRetries = 0;
  answerStr = '';
  currentProblem = generateProblem();

  $problem.classList.add('fade-out');
  setTimeout(() => {
    $problem.textContent = currentProblem.a + ' ' + currentProblem.op + ' ' + currentProblem.b + ' = ?';
    $problem.classList.remove('fade-out');
    $problem.classList.add('correct-pulse');
    setTimeout(() => $problem.classList.remove('correct-pulse'), 400);
  }, 200);

  $answerDigits.textContent = '';
  $feedback.textContent = '';
  $visualExplanation.style.display = 'none';
  $visualExplanation.innerHTML = '';
  buildNumpad(false);
}

function buildNumpad(showNext) {
  $numpad.innerHTML = '';
  if (showNext) {
    const btn = document.createElement('button');
    btn.className = 'num-btn next';
    btn.textContent = 'UrmÄƒtoarea â–¶';
    btn.addEventListener('click', showProblem);
    $numpad.appendChild(btn);
    return;
  }

  for (let i = 1; i <= 9; i++) {
    const btn = document.createElement('button');
    btn.className = 'num-btn digit';
    btn.textContent = i;
    btn.addEventListener('click', () => pressDigit(i));
    $numpad.appendChild(btn);
  }
  // Row: Clear, 0, Submit
  const clearBtn = document.createElement('button');
  clearBtn.className = 'num-btn clear';
  clearBtn.textContent = 'È˜terge';
  clearBtn.addEventListener('click', pressClear);
  $numpad.appendChild(clearBtn);

  const zeroBtn = document.createElement('button');
  zeroBtn.className = 'num-btn digit';
  zeroBtn.textContent = '0';
  zeroBtn.addEventListener('click', () => pressDigit(0));
  $numpad.appendChild(zeroBtn);

  const submitBtn = document.createElement('button');
  submitBtn.className = 'num-btn submit';
  submitBtn.textContent = 'Trimite';
  submitBtn.addEventListener('click', pressSubmit);
  $numpad.appendChild(submitBtn);
}

function pressDigit(d) {
  if (waitingForNext) return;
  if (answerStr.length >= 4) return;
  answerStr += d;
  $answerDigits.textContent = answerStr;
}

function pressClear() {
  if (waitingForNext) return;
  answerStr = '';
  $answerDigits.textContent = '';
}

function pressSubmit() {
  if (waitingForNext) return;
  if (answerStr === '') return;

  const userAnswer = parseInt(answerStr, 10);
  state.totalAttempts++;

  if (userAnswer === currentProblem.answer) {
    handleCorrect();
  } else {
    handleWrong();
  }
  saveState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWER HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleCorrect() {
  state.totalSolved++;
  state.correctCount++;
  state.streak++;
  state.consecCorrect++;
  if (state.streak > state.bestStreak) state.bestStreak = state.streak;

  // Award star
  state.stars++;
  spawnStarBurst();

  // Difficulty scaling
  if (state.consecCorrect >= 5 && state.difficulty < 5) {
    state.difficulty++;
    state.consecCorrect = 0;
  }

  // Feedback
  const msg = CORRECT_MSGS[Math.floor(Math.random() * CORRECT_MSGS.length)];
  $feedback.textContent = msg;
  $feedback.style.color = '#2D8A2E';
  $problem.textContent = currentProblem.a + ' ' + currentProblem.op + ' ' + currentProblem.b + ' = ' + currentProblem.answer;
  $answerDigits.textContent = '';
  $problem.classList.add('correct-pulse');
  setTimeout(() => $problem.classList.remove('correct-pulse'), 400);

  renderProgress();
  renderStreak();

  // Check for new animal (every 5 stars)
  if (state.stars % 5 === 0 && state.animalsCollected < ANIMALS.length) {
    const animalIdx = state.animalsCollected;
    state.animalsCollected++;
    renderZoo();
    renderProgress();
    saveState();

    // Show animal popup after a brief delay
    setTimeout(() => showNewAnimalPopup(animalIdx), 600);
    waitingForNext = true;
    buildNumpad(true);
    return;
  }

  // Check for streak of 10
  if (state.streak === 10) {
    triggerSuperStar();
    waitingForNext = true;
    buildNumpad(true);
    saveState();
    return;
  }

  waitingForNext = true;
  buildNumpad(true);
  saveState();
}

function handleWrong() {
  currentRetries++;
  state.streak = 0;
  state.consecCorrect = 0;
  renderStreak();

  if (currentRetries < 2) {
    // Retry
    const msg = RETRY_MSGS[Math.floor(Math.random() * RETRY_MSGS.length)];
    $feedback.textContent = msg;
    $feedback.style.color = '#C0600A';
    answerStr = '';
    $answerDigits.textContent = '';

    // Shake the answer area
    const ansDisp = document.getElementById('answer-display');
    ansDisp.classList.add('shake');
    setTimeout(() => ansDisp.classList.remove('shake'), 500);
  } else {
    // Show answer
    state.totalSolved++;
    $feedback.textContent = 'RÄƒspunsul corect era ' + currentProblem.answer + '. Data viitoare reuÈ™eÈ™ti! ğŸ’ª';
    $feedback.style.color = '#8A4B2D';
    $problem.textContent = currentProblem.a + ' ' + currentProblem.op + ' ' + currentProblem.b + ' = ' + currentProblem.answer;
    $answerDigits.textContent = '';

    showVisualExplanation();
    waitingForNext = true;
    buildNumpad(true);
  }
  saveState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VISUAL EXPLANATION (dots)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showVisualExplanation() {
  const p = currentProblem;
  $visualExplanation.innerHTML = '';
  $visualExplanation.style.display = 'flex';

  if (p.op === '+' && p.a <= 15 && p.b <= 15) {
    // Show groups of dots
    const row1 = createDotRow(p.a, COLORS[0]);
    const plus = document.createElement('div');
    plus.className = 'dot-label';
    plus.textContent = '+';
    const row2 = createDotRow(p.b, COLORS[3]);
    const eq = document.createElement('div');
    eq.className = 'dot-label';
    eq.textContent = '= ' + p.answer;
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'display:flex; flex-direction:column; align-items:center; gap:6px;';
    wrapper.appendChild(row1);
    wrapper.appendChild(plus);
    wrapper.appendChild(row2);
    wrapper.appendChild(eq);
    $visualExplanation.appendChild(wrapper);
  } else if (p.op === '-' && p.a <= 15) {
    const row = createDotRow(p.a, COLORS[0], p.b);
    const eq = document.createElement('div');
    eq.className = 'dot-label';
    eq.textContent = p.a + ' - ' + p.b + ' = ' + p.answer;
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'display:flex; flex-direction:column; align-items:center; gap:6px;';
    wrapper.appendChild(row);
    wrapper.appendChild(eq);
    $visualExplanation.appendChild(wrapper);
  } else if (p.op === 'Ã—' && p.a <= 5 && p.b <= 5) {
    // Grid of dots
    const grid = document.createElement('div');
    grid.style.cssText = 'display:flex; flex-direction:column; gap:4px; align-items:center;';
    for (let r = 0; r < p.a; r++) {
      grid.appendChild(createDotRow(p.b, COLORS[r % COLORS.length]));
    }
    const eq = document.createElement('div');
    eq.className = 'dot-label';
    eq.textContent = p.a + ' Ã— ' + p.b + ' = ' + p.answer;
    grid.appendChild(eq);
    $visualExplanation.appendChild(grid);
  } else {
    // Simple text explanation for large numbers
    const txt = document.createElement('div');
    txt.className = 'explanation-text';
    txt.textContent = p.a + ' ' + p.op + ' ' + p.b + ' = ' + p.answer;
    $visualExplanation.appendChild(txt);
  }
}

function createDotRow(count, color, crossedAfter) {
  const row = document.createElement('div');
  row.className = 'dot-row';
  for (let i = 0; i < count; i++) {
    const dot = document.createElement('span');
    dot.className = 'dot';
    dot.style.background = color;
    if (crossedAfter !== undefined && i >= count - crossedAfter) {
      dot.style.opacity = '0.3';
      dot.style.textDecoration = 'line-through';
    }
    row.appendChild(dot);
  }
  return row;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CELEBRATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function spawnStarBurst() {
  const star = document.createElement('div');
  star.className = 'star-burst';
  star.textContent = 'â­';
  star.style.left = (Math.random() * 60 + 20) + '%';
  star.style.top = '40%';
  document.body.appendChild(star);
  setTimeout(() => star.remove(), 1000);
}

function showNewAnimalPopup(idx) {
  const animal = ANIMALS[idx];
  document.getElementById('popup-animal-emoji').textContent = animal.emoji;
  document.getElementById('popup-animal-name').textContent = animal.name;
  document.getElementById('new-animal-popup').classList.add('open');
}

document.getElementById('popup-close').addEventListener('click', () => {
  document.getElementById('new-animal-popup').classList.remove('open');
});

function triggerSuperStar() {
  const overlay = document.getElementById('celebration-overlay');
  const text = document.getElementById('celebration-text');
  text.textContent = 'INCREDIBIL! 10 rÄƒspunsuri corecte la rÃ¢nd! EÈ™ti o SUPER STEA! âœ¨ğŸŒŸâ­';
  overlay.classList.add('active');
  launchConfetti();
  setTimeout(() => {
    overlay.classList.remove('active');
  }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function launchConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx.scale(dpr, dpr);

  const pieces = [];
  const confettiColors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#FF6FD8','#C490E4','#FF9671','#FFC75F'];

  const logicalW = window.innerWidth;
  const logicalH = window.innerHeight;
  for (let i = 0; i < 150; i++) {
    pieces.push({
      x: Math.random() * logicalW,
      y: Math.random() * logicalH - logicalH,
      w: Math.random() * 10 + 5,
      h: Math.random() * 6 + 3,
      color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
      vy: Math.random() * 3 + 2,
      vx: Math.random() * 2 - 1,
      rot: Math.random() * 360,
      rotSpeed: Math.random() * 8 - 4,
    });
  }

  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, logicalW, logicalH);
    let alive = false;
    pieces.forEach(p => {
      p.y += p.vy;
      p.x += p.vx;
      p.rot += p.rotSpeed;
      if (p.y < logicalH + 20) alive = true;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      ctx.restore();
    });

    frame++;
    if (alive && frame < 200) {
      requestAnimationFrame(draw);
    } else {
      ctx.clearRect(0, 0, logicalW, logicalH);
    }
  }
  requestAnimationFrame(draw);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('stats-btn').addEventListener('click', () => {
  document.getElementById('stat-solved').textContent = state.totalSolved;
  const accuracy = state.totalAttempts > 0
    ? Math.round((state.correctCount / state.totalAttempts) * 100)
    : 0;
  document.getElementById('stat-accuracy').textContent = accuracy + '%';
  document.getElementById('stat-animals').textContent = state.animalsCollected + ' / ' + ANIMALS.length;
  document.getElementById('stat-best-streak').textContent = state.bestStreak;
  document.getElementById('stats-overlay').classList.add('open');
});

document.getElementById('stats-close').addEventListener('click', () => {
  document.getElementById('stats-overlay').classList.remove('open');
});

document.getElementById('stats-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('stats-overlay')) {
    document.getElementById('stats-overlay').classList.remove('open');
  }
});

document.getElementById('reset-btn').addEventListener('click', () => {
  if (confirm('EÈ™ti sigur cÄƒ vrei sÄƒ resetezi tot progresul?')) {
    state = defaultState();
    saveState();
    renderZoo();
    renderProgress();
    renderStreak();
    showProblem();
    document.getElementById('stats-overlay').classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SUPPORT (for desktops)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('keydown', (e) => {
  if (document.getElementById('stats-overlay').classList.contains('open')) return;
  if (document.getElementById('new-animal-popup').classList.contains('open')) return;

  if (e.key >= '0' && e.key <= '9') {
    pressDigit(parseInt(e.key));
  } else if (e.key === 'Backspace' || e.key === 'Delete') {
    pressClear();
  } else if (e.key === 'Enter') {
    if (waitingForNext) {
      showProblem();
    } else {
      pressSubmit();
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  iOS SAFARI VIEWPORT FIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setViewportHeight() {
  const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  document.documentElement.style.setProperty('--app-height', vh + 'px');
}

setViewportHeight();

if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', setViewportHeight);
} else {
  window.addEventListener('resize', setViewportHeight);
}

// Prevent iOS Safari bounce/pull-to-refresh
document.addEventListener('touchmove', function(e) {
  if (e.target.closest('#game-card')) return;
  if (e.touches.length === 1) {
    e.preventDefault();
  }
}, { passive: false });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

renderZoo();
renderProgress();
renderStreak();
showProblem();

</script>
</body>
</html>
